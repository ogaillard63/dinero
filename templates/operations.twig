{% extends "layout.twig" %}

{% block title %}Opérations{% endblock %}

{% block content %}
    <h2 class="text-3xl font-light mb-8 text-gray-800">Opérations</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main content: Transactions list (2/3) -->
        <div class="lg:col-span-2">
            <div class="bg-white border border-gray-200 shadow-sm">
                <div class="px-6 py-3 border-b border-gray-100 bg-gray-50">
                    <div class="mb-3">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Rechercher dans les opérations..." 
                            class="shadow-none appearance-none border border-gray-300 w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:border-gray-500"
                        >
                    </div>
                    <div class="grid grid-cols-4 gap-3 text-sm">
                        <div class="bg-white p-2 border border-gray-200">
                            <div class="text-xs text-gray-500 uppercase">Affichées</div>
                            <div class="text-base font-bold text-gray-900" id="visibleCount">{{ transactions|length }}</div>
                        </div>
                        <div class="bg-white p-2 border border-gray-200">
                            <div class="text-xs text-gray-500 uppercase">Total</div>
                            <div class="text-base font-bold text-gray-900" id="totalCount">{{ transactions|length }}</div>
                        </div>
                        <div class="bg-green-50 p-2 border border-green-200">
                            <div class="text-xs text-green-600 uppercase">Crédits</div>
                            <div class="text-base font-bold text-green-600" id="creditTotal">0,00 €</div>
                        </div>
                        <div class="bg-red-50 p-2 border border-red-200">
                            <div class="text-xs text-red-600 uppercase">Débits</div>
                            <div class="text-base font-bold text-red-600" id="debitTotal">0,00 €</div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100">Date</th>
                                <th class="px-6 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100">Description</th>
                                <th class="px-6 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100">Type</th>
                                <th class="px-6 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100 text-right">Montant</th>
                                <th class="px-6 py-3 bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for transaction in transactions %}
                            <tr class="hover:bg-gray-50 transition-colors duration-150">
                                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">{{ transaction.date|date("d/m/Y") }}</td>
                                <td class="px-6 py-3 text-sm text-gray-900">{{ transaction.description }}</td>
                                <td class="px-6 py-3 whitespace-nowrap text-xs text-gray-500 uppercase">{{ transaction.type }}</td>
                                <td class="px-6 py-3 whitespace-nowrap text-sm text-right font-medium {{ transaction.amount < 0 ? 'text-red-600' : 'text-green-600' }}">
                                    {{ transaction.amount|number_format(2, ',', ' ') }} €
                                </td>
                                <td class="px-6 py-3 whitespace-nowrap text-right">
                                    <div class="flex justify-end space-x-2">
                                        <a href="/admin/transactions/{{ transaction.id }}/edit" class="text-xs uppercase font-bold text-gray-500 hover:text-black px-2 py-1 border border-gray-300 hover:border-black transition-colors">Modifier</a>
                                        <form action="/admin/transactions/{{ transaction.id }}/delete" method="POST" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette transaction ?');" class="inline">
                                            <button type="submit" class="text-xs uppercase font-bold text-red-500 hover:text-red-700 px-2 py-1 border border-red-300 hover:border-red-700 transition-colors">Supprimer</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-sm text-gray-500">
                                    {% if selected_account %}
                                        Aucune opération sur ce compte.
                                    {% else %}
                                        Sélectionnez un compte pour voir les opérations.
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar: Account selector and Add button (1/3) -->
        <div class="lg:col-span-1">
            <div class="bg-white border border-gray-200 shadow-sm p-6 sticky top-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4 tracking-wider">Compte</h3>
                
                {% if accounts %}
                    <div class="mb-6">
                        <select 
                            id="account-selector" 
                            class="shadow-none appearance-none border border-gray-300 w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:border-gray-500"
                            onchange="window.location='/admin/operations?account_id=' + this.value"
                        >
                            {% for account in accounts %}
                            <option value="{{ account.id }}" {{ selected_account and selected_account.id == account.id ? 'selected' : '' }}>
                                {{ account.bank_name }} - {{ account.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    {% if selected_account %}
                    <div class="mb-6 p-4 bg-gray-50 border border-gray-200">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Solde actuel</div>
                        <div class="text-2xl font-bold text-gray-900">{{ selected_account.current_balance|number_format(2, ',', ' ') }} €</div>
                        <div class="text-xs text-gray-400 mt-1">{{ selected_account.number }}</div>
                    </div>

                    <button onclick="openAddTransactionModal()" class="block w-full bg-black text-white text-center py-3 px-6 uppercase text-sm tracking-wider hover:bg-gray-800 transition-colors">
                        + Ajouter une opération
                    </button>
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 text-sm">Aucun compte disponible.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for adding transaction -->
    <div id="addTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white border border-gray-200 shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Ajouter une opération</h3>
                <button onclick="closeAddTransactionModal()" class="text-gray-500 hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <div id="modalError" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden" role="alert"></div>
                
                <form id="addTransactionForm">
                    <input type="hidden" name="account_id" id="modal_account_id" value="{{ selected_account ? selected_account.id : '' }}">
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2 uppercase" for="modal_date">Date</label>
                        <input 
                            class="shadow-none appearance-none border border-gray-300 w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:border-gray-500" 
                            id="modal_date" 
                            name="date" 
                            type="date" 
                            value="{{ 'now'|date('Y-m-d') }}"
                            required
                        >
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2 uppercase" for="modal_description">Description</label>
                        <input 
                            class="shadow-none appearance-none border border-gray-300 w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:border-gray-500" 
                            id="modal_description" 
                            name="description" 
                            type="text" 
                            placeholder="Ex: Achat supermarché"
                            required
                        >
                    </div>

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2 uppercase" for="modal_type">Type</label>
                            <select 
                                class="shadow-none appearance-none border border-gray-300 w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:border-gray-500" 
                                id="modal_type" 
                                name="type"
                                required
                            >
                                <option value="credit">Crédit (+)</option>
                                <option value="debit" selected>Débit (-)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2 uppercase" for="modal_amount">Montant</label>
                            <input 
                                class="shadow-none appearance-none border border-gray-300 w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:border-gray-500" 
                                id="modal_amount" 
                                name="amount" 
                                type="number" 
                                step="0.01"
                                placeholder="0.00"
                                required
                            >
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeAddTransactionModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 focus:outline-none uppercase tracking-wider transition-colors duration-200">
                            Annuler
                        </button>
                        <button type="submit" class="bg-black hover:bg-gray-800 text-white font-bold py-3 px-8 focus:outline-none uppercase tracking-wider transition-colors duration-200">
                            Ajouter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Search and totals functionality
        const searchInput = document.getElementById('searchInput');
        const tbody = document.querySelector('tbody');
        const transactionRows = tbody ? Array.from(tbody.querySelectorAll('tr')).filter(row => row.querySelectorAll('td').length > 1) : [];
        
        function updateTotals() {
            let visibleCount = 0;
            let creditTotal = 0;
            let debitTotal = 0;
            
            transactionRows.forEach(row => {
                if (row.style.display !== 'none') {
                    visibleCount++;
                    
                    // Get amount from the row
                    const amountCell = row.querySelector('td:nth-child(4)');
                    if (amountCell) {
                        const amountText = amountCell.textContent.trim();
                        const amount = parseFloat(amountText.replace(/\s/g, '').replace(',', '.').replace('€', ''));
                        
                        if (amount > 0) {
                            creditTotal += amount;
                        } else {
                            debitTotal += Math.abs(amount);
                        }
                    }
                }
            });
            
            document.getElementById('visibleCount').textContent = visibleCount;
            document.getElementById('creditTotal').textContent = creditTotal.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('debitTotal').textContent = debitTotal.toFixed(2).replace('.', ',') + ' €';
        }
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                transactionRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                updateTotals();
            });
            
            // Initial totals calculation
            updateTotals();
        }
        
        function openAddTransactionModal() {
            document.getElementById('addTransactionModal').classList.remove('hidden');
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('addTransactionForm').reset();
            document.getElementById('modal_date').value = new Date().toISOString().split('T')[0];
            {% if selected_account %}
            document.getElementById('modal_account_id').value = '{{ selected_account.id }}';
            {% endif %}
        }

        function closeAddTransactionModal() {
            document.getElementById('addTransactionModal').classList.add('hidden');
        }

        document.getElementById('addTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const accountId = formData.get('account_id');
            
            fetch(`/admin/accounts/${accountId}/transactions/create`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    // Success - reload the page to show new transaction
                    window.location.reload();
                } else {
                    return response.text();
                }
            })
            .catch(error => {
                document.getElementById('modalError').textContent = 'Une erreur est survenue.';
                document.getElementById('modalError').classList.remove('hidden');
            });
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddTransactionModal();
            }
        });

        // Close modal on backdrop click
        document.getElementById('addTransactionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddTransactionModal();
            }
        });
    </script>
{% endblock %}
