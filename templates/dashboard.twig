{% extends "layout.twig" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <h2 class="text-3xl font-light mb-8 text-primary">Vue d'ensemble</h2>

    <div class="grid grid-cols-2 gap-6 mb-8">
        <!-- Total Balance Card -->
        <div class="bg-white p-6 border border-gray-200 shadow-sm">
            <div class="text-sm text-gray-500 uppercase tracking-wider mb-2 text-right">Solde Total</div>
            <div class="text-3xl font-bold text-primary text-right">{{ totalBalance|number_format(0, ',', ' ') }} €</div>
        </div>
        
        <!-- Balance Variation Card -->
        <div class="bg-white p-6 border border-gray-200 shadow-sm">
            <div class="text-sm text-gray-500 uppercase tracking-wider mb-2 text-right">Variation 30j</div>
            <div class="text-3xl font-bold text-right">
                {% if balanceVariation > 0 %}
                    <span class="text-green-600">+{{ balanceVariation|number_format(2, ',', ' ') }} €</span>
                {% elseif balanceVariation < 0 %}
                    <span class="text-red-600">{{ balanceVariation|number_format(2, ',', ' ') }} €</span>
                {% else %}
                    <span class="text-gray-500">0,00 €</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Balance Evolution Chart -->
    <div class="bg-white border border-gray-200 shadow-sm p-4 md:p-6 mb-8">
        <div class="mb-6">
            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Évolution du solde global</h3>
        </div>
        <div class="relative h-[250px] md:h-[350px] w-full">
            <canvas id="balanceChart"></canvas>
        </div>
    </div>


    <!-- Chart.js with Zoom Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script>
        const ctx = document.getElementById('balanceChart').getContext('2d');
        const balanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ monthlyData.labels|json_encode|raw }},
                datasets: [{
                    label: 'Solde global (€)',
                    data: {{ monthlyData.balances|json_encode|raw }},
                    borderColor: '#0B508C',
                    backgroundColor: 'rgba(11, 80, 140, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#0B508C',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#0B508C',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#0B508C',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(2).replace('.', ',') + ' €';
                            }
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                                speed: 0.1
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x'
                        },
                        pan: {
                            enabled: true,
                            mode: 'x'
                        },
                        limits: {
                            x: {min: 'original', max: 'original'}
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                if (Math.abs(value) >= 1000) {
                                    return (value / 1000).toFixed(0) + 'K€';
                                }
                                return value + '€';
                            }
                        },
                        grid: {
                            color: '#e5e7eb'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Zoom initial adapté à la taille de l'écran
        setTimeout(() => {
            const totalPoints = balanceChart.data.labels.length;
            const isMobile = window.innerWidth < 768;
            const daysToDisplay = isMobile ? 10 : 30; // 10 jours sur mobile, 30 sur desktop
            
            if (totalPoints > daysToDisplay) {
                const startIndex = totalPoints - daysToDisplay;
                balanceChart.zoomScale('x', {min: startIndex, max: totalPoints - 1}, 'default');
            }
        }, 200);
    </script>
{% endblock %}

